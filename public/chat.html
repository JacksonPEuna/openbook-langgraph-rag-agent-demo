<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EUNA Solutions - AI Budget Assistant</title>
    <link rel="stylesheet" href="ai-panel.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        
        .main-content {
            flex: 1;
            height: 100vh;
            position: relative;
        }
        
        .main-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
            transition: pointer-events 0.1s;
        }
        
        .main-content iframe.dragging {
            pointer-events: none;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #F6F6F9;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #4a5568;
            font-size: 14px;
        }
        
        .sidebar {
            width: 316px;
            min-width: 316px;
            max-width: 632px;
            height: 100vh;
            flex-shrink: 0;
            position: relative;
            z-index: 20;
        }
        
        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }
        
        .message {
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 12px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .message.user {
            align-self: flex-end;
            background: transparent;
            color: #534793;
            border: 1px solid #534793;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            align-self: flex-start;
            background: transparent;
            color: #534793;
            border: none;
            padding: 0;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .message.assistant .ai-response-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .message.assistant .ai-response-content {
            flex: 1;
        }
        
        .message.system {
            align-self: center;
            background: var(--cool-gray-20);
            color: var(--cool-gray-50);
            font-style: italic;
            font-size: 12px;
            padding: 8px 12px;
            border-radius: 12px;
        }
        
        /* Markdown-rendered content styles for assistant messages */
        .message.assistant p {
            margin: 0 0 4px 0;
            color: #534793;
            font-size: 12px;
        }

        .message.assistant p:last-child {
            margin-bottom: 0;
        }

        .message.assistant strong {
            font-weight: 600;
            color: #534793;
        }

        .message.assistant em {
            font-style: italic;
            color: #534793;
        }

        .message.assistant h1,
        .message.assistant h2,
        .message.assistant h3,
        .message.assistant h4 {
            color: #534793;
            margin: 8px 0 4px 0;
            font-size: 12px;
            font-weight: 600;
        }

        .message.assistant h1 { font-size: 14px; }
        .message.assistant h2 { font-size: 13px; }

        .message.assistant ol {
            margin: 4px 0 !important;
            padding-left: 24px !important;
            color: #534793;
            font-size: 12px;
            list-style: decimal outside !important;
        }

        .message.assistant ul {
            margin: 4px 0;
            padding-left: 20px;
            color: #534793;
            font-size: 12px;
        }

        .message.assistant ol li,
        .message.assistant ul li {
            margin: 2px 0;
            line-height: 1.4;
            color: #534793;
            font-size: 12px;
        }

        .message.assistant code {
            background: #e5e7ec;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 11px;
        }

        .message.assistant pre {
            background: #e5e7ec;
            padding: 8px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 11px;
            margin: 4px 0;
        }

        .message.assistant pre code {
            background: none;
            padding: 0;
        }

        .message.assistant table {
            border-collapse: collapse;
            margin: 4px 0;
            font-size: 11px;
            width: 100%;
        }

        .message.assistant th,
        .message.assistant td {
            border: 1px solid #caced8;
            padding: 4px 8px;
            text-align: left;
            color: #534793;
        }

        .message.assistant th {
            background: #e5e7ec;
            font-weight: 600;
        }

        .message.assistant blockquote {
            border-left: 3px solid #a08ffa;
            margin: 4px 0;
            padding-left: 12px;
            color: #534793;
            font-style: italic;
        }

        .message.assistant a {
            color: #534793;
            text-decoration: underline;
        }

        .message.assistant br {
            display: block;
            margin: 2px 0;
        }
        
        .typing-indicator {
            align-self: flex-start;
            background: transparent;
            border: none;
            padding: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #534793;
            font-size: 12px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--cool-gray-50);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Override AI panel styles for sidebar layout */
        .ai-panel {
            width: 100%;
            height: 100vh;
            max-height: none;
            border-left: 1px solid var(--cool-gray-30);
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }
        
        .ai-panel__content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            min-height: 0;
        }
        
        .ai-panel__intro {
            padding: 16px;
            border-bottom: none;
            flex-shrink: 0;
        }
        
        /* Icon sizing for expanded mode */
        .ai-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ai-icon img {
            width: 60px;
            height: 60px;
            display: block;
            object-fit: contain;
            object-position: center;
        }
        
        .ai-panel__examples {
            padding: 16px;
            padding-top: 0;
            padding-bottom: 0;
            border-bottom: none;
            flex-shrink: 0;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .example-question {
            width: 100% !important;
        }
        
        .ai-input {
            margin: 16px;
            margin-top: 0;
            flex-shrink: 0;
            width: calc(100% - 32px) !important;
            max-width: calc(100% - 32px) !important;
        }
        
        .ai-input__field {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Input focus state */
        .ai-input:focus-within {
            background-color: white;
        }
        
        .ai-input__text:focus {
            outline: none;
        }
        
        /* Hide mode toggle slider */
        .mode-toggle {
            display: none !important;
        }
        
        /* Status indicator removed */
        
        /* Collapsed panel styles */
        .sidebar.collapsed {
            width: 48px !important;
            min-width: 48px !important;
            max-width: 48px !important;
        }
        
        .ai-panel.collapsed {
            width: 48px !important;
            min-width: 48px !important;
            max-width: 48px !important;
            background-color: transparent !important;
            border-left: none !important;
            border-right: none !important;
            border-top: none !important;
            border-bottom: none !important;
        }
        
        /* Resize handle */
        .ai-panel__handle {
            position: absolute;
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 40px;
            background-color: var(--cool-gray-10);
            border: 1px solid var(--cool-gray-30);
            border-radius: var(--radius-lg);
            cursor: ew-resize;
            z-index: 30;
            transition: background-color 0.2s ease;
        }
        
        .ai-panel__handle:hover {
            background-color: var(--cool-gray-20);
        }
        
        .ai-panel__handle:active {
            background-color: var(--cool-gray-30);
        }
        
        .ai-panel.collapsed .ai-panel__handle {
            display: none;
        }
        
        /* Collapsed state styles */
        .ai-panel.collapsed .ai-panel__content {
            padding: 0 8px 8px;
            width: 48px !important;
            overflow: hidden;
            background-color: var(--cool-gray-10);
            border-left: 1px solid var(--cool-gray-30);
            position: relative;
            z-index: 10;
        }
        
        .ai-panel.collapsed .ai-panel__header {
            justify-content: center;
            width: 48px;
        }
        
        .ai-panel.collapsed .mode-toggle {
            display: none;
        }
        
        .ai-panel.collapsed .ai-panel__intro {
            gap: 4px;
        }
        
        .ai-panel.collapsed .ai-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }
        
        .ai-panel.collapsed .ai-icon img {
            width: 24px !important;
            height: 24px !important;
        }
        
        .ai-panel.collapsed .toggle-side-panel {
            transform: rotate(180deg);
        }
        
        .ai-panel.collapsed .ai-panel__title {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 12px;
            line-height: 28px;
            height: auto;
            width: auto;
            display: flex !important;
            align-items: center;
            justify-content: center;
            transform: rotate(180deg);
            white-space: nowrap;
        }
        
        .ai-panel.collapsed .ai-panel__examples,
        .ai-panel.collapsed .ai-input,
        .ai-panel.collapsed .chat-messages {
            display: none !important;
        }
        
        .ai-panel.collapsed .ai-panel__intro {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Main content area with iframe -->
        <div class="main-content">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">Loading OpenBook...</div>
            </div>
            <iframe 
                src="https://opencity.openbook-uat.questica.com/#/login?redirectUrl=https%3A%2F%2Fopencity.openbook-uat.questica.com%2F%23%2Fbudget-book-builder%2Fedit%2Fa7ae7ed5-8092-488e-a279-20498ebb9197%2Fdashboard" 
                title="OpenBook Budget Builder Dashboard"
                onload="hideLoading()"
                onerror="showError()">
            </iframe>
        </div>
        
        <!-- AI Panel Sidebar -->
        <div class="sidebar">
            <div class="ai-panel">
                <!-- Header with toggle and mode selector -->
                <div class="ai-panel__header">
                    <div class="toggle-button">
                        <button class="toggle-side-panel" aria-label="Toggle side panel">
                            <img src="icons/toolbar-icon.svg" alt="Toggle panel" width="16" height="16">
                        </button>
                    </div>
                    
                    <div class="mode-toggle">
                        <div class="mode-toggle__track">
                            <div class="mode-toggle__thumb"></div>
                            <div class="mode-toggle__option mode-toggle__option--ai">
                                <img src="https://www.figma.com/api/mcp/asset/766471cb-dc1b-46dc-954e-1cd776a1e7c7" alt="AI mode" width="16" height="16">
                            </div>
                            <div class="mode-toggle__option mode-toggle__option--internal">
                                <img src="https://www.figma.com/api/mcp/asset/e632bc10-b13b-4483-bd8f-95c85a4aaaba" alt="Internal mode" width="16" height="16">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main content area -->
                <div class="ai-panel__content">
                    <!-- AI Icon and title -->
                    <div class="ai-panel__intro">
                        <div class="ai-icon">
                            <img src="icons/EunaAI.svg" alt="Euna AI" width="60" height="60">
                        </div>
                        <p class="ai-panel__title">Euna AI System</p>
                    </div>

                    <!-- Example questions -->
                    <div class="ai-panel__examples">
                        <button class="example-question" data-question="How much is the total budget?">
                            How much is the total budget?
                        </button>
                        <button class="example-question" data-question="What departments are included in this budget?">
                            What departments are included in this budget?
                        </button>
                        <button class="example-question" data-question="What are the main revenue sources?">
                            What are the main revenue sources?
                        </button>
                        <button class="example-question" data-question="Tell me about capital projects in the budget">
                            Tell me about capital projects
                        </button>
                    </div>

                    <!-- Chat Messages Area (hidden initially) -->
                    <div class="chat-messages" id="chatMessages" style="display: none;">
                    </div>

                    <!-- Input area -->
                    <div class="ai-input">
                        <div class="ai-input__field">
                            <input type="text" placeholder="Ask about budget data..." class="ai-input__text" id="messageInput">
                            <button class="ai-input__submit" id="sendButton" aria-label="Send message">
                                <img src="https://www.figma.com/api/mcp/asset/33ad4a73-f6e1-4b7a-bb01-9cc3a4c4be8e" alt="Send" width="32" height="32">
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Side handle -->
                <div class="ai-panel__handle" title="Drag to resize panel"></div>
            </div>
        </div>
    </div>

    <script>
        // Chat functionality
        class ChatApp {
            constructor() {
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatMessages = document.getElementById('chatMessages');
                this.isFirstMessage = true;
                
                this.init();
            }
            
            init() {
                // Event listeners
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Example question clicks
                document.querySelectorAll('.example-question').forEach(button => {
                    button.addEventListener('click', () => {
                        const question = button.dataset.question;
                        this.messageInput.value = question;
                        this.sendMessage();
                    });
                });
            }
            
            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;
                
                // Handle first message - show chat interface
                if (this.isFirstMessage) {
                    this.showChatInterface();
                    this.isFirstMessage = false;
                }
                
                // Add user message to chat
                this.addMessage('user', message);
                this.messageInput.value = '';
                
                // Show typing indicator
                this.showTyping();
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message })
                    });
                    
                    const data = await response.json();
                    
                    // Remove typing indicator
                    this.hideTyping();
                    
                    if (data.success) {
                        // Log thinking parts to console
                        if (data.thinking && data.thinking.length > 0) {
                            console.group('ü§î AI Thinking Process:');
                            data.thinking.forEach((thought, index) => {
                                console.log(`Thought ${index + 1}:`, thought.trim());
                            });
                            console.groupEnd();
                        }
                        
                        // Add formatted response to chat (markdown parsed client-side)
                        this.addMessage('assistant', data.response);
                    } else {
                        this.addMessage('assistant', data.response || 'Sorry, I encountered an error processing your request.');
                    }
                    
                } catch (error) {
                    this.hideTyping();
                    this.addMessage('assistant', 'Sorry, I\'m having trouble connecting to the server. Please try again.');
                    console.error('Chat error:', error);
                }
            }
            
            addMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;

                if (type === 'assistant') {
                    // Add AI icon to assistant messages
                    const iconDiv = document.createElement('img');
                    iconDiv.src = 'icons/EunaAI.svg';
                    iconDiv.alt = 'AI';
                    iconDiv.className = 'ai-response-icon';
                    messageDiv.appendChild(iconDiv);

                    // Add content wrapper ‚Äî parse markdown to HTML
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'ai-response-content';
                    contentDiv.innerHTML = marked.parse(content);

                    messageDiv.appendChild(contentDiv);
                } else {
                    messageDiv.textContent = content;
                }
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span>Euna AI is thinking...</span>
                `;
                
                this.chatMessages.appendChild(typingDiv);
                this.scrollToBottom();
            }
            
            hideTyping() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            scrollToBottom() {
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
            
            showChatInterface() {
                // Hide intro and examples
                const intro = document.querySelector('.ai-panel__intro');
                const examples = document.querySelector('.ai-panel__examples');
                
                if (intro) intro.style.display = 'none';
                if (examples) examples.style.display = 'none';
                
                // Show chat messages
                this.chatMessages.style.display = 'flex';
            }
        }
        
        // Loading management for iframe
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 300);
            }
        }
        
        function showError() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.innerHTML = `
                    <div style="text-align: center; color: #e53e3e;">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚ö†Ô∏è</div>
                        <div>Unable to load OpenBook</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #718096;">
                            The page may have security restrictions or be unavailable
                        </div>
                    </div>
                `;
            }
        }
        
        // Initialize chat app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ChatApp();
        });
        
        // Panel toggle and resize functionality
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.querySelector('.toggle-side-panel');
            const handle = document.querySelector('.ai-panel__handle');
            const sidebar = document.querySelector('.sidebar');
            const aiPanel = document.querySelector('.ai-panel');
            const iframe = document.querySelector('.main-content iframe');
            let isCollapsed = false;
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;
            
            // Toggle functionality
            toggleBtn.addEventListener('click', function() {
                isCollapsed = !isCollapsed;
                
                if (isCollapsed) {
                    sidebar.classList.add('collapsed');
                    aiPanel.classList.add('collapsed');
                } else {
                    sidebar.classList.remove('collapsed');
                    aiPanel.classList.remove('collapsed');
                }
            });
            
            // Resize functionality
            handle.addEventListener('mousedown', function(e) {
                if (isCollapsed) return; // Don't resize when collapsed
                
                isResizing = true;
                startX = e.clientX;
                startWidth = sidebar.offsetWidth;
                
                // Disable iframe pointer events during drag
                iframe.classList.add('dragging');
                
                // Prevent text selection during drag
                e.preventDefault();
                document.body.style.cursor = 'ew-resize';
                document.body.style.userSelect = 'none';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                // Calculate new width (drag left = wider, drag right = narrower)
                const deltaX = startX - e.clientX;
                const newWidth = startWidth + deltaX;
                
                // Constrain width between min (316px) and max (632px - twice the default)
                const minWidth = 316;
                const maxWidth = 632;
                const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                
                // Apply new width with min/max constraints
                sidebar.style.width = constrainedWidth + 'px';
                sidebar.style.minWidth = constrainedWidth + 'px';
                sidebar.style.maxWidth = constrainedWidth + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    
                    // Re-enable iframe pointer events
                    iframe.classList.remove('dragging');
                    
                    // Restore cursor and selection
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        });
    </script>
</body>
</html>